<html xmlns:fo="http://www.w3.org/1999/XSL/Format">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   
      <title>12.6.2.&nbsp;Solution</title>
      <link rel="stylesheet" href="../css/html.css" type="text/css">
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0">
      <link rel="start" href="book.html" title="Jakarta Commons Cookbook">
      <link rel="up" href="jakartackbk-CHP-12-SECT-6.html" title="12.6.&nbsp;Creating an Index of XML Documents">
      <link rel="prev" href="jakartackbk-CHP-12-SECT-6.html" title="12.6.&nbsp;Creating an Index of XML Documents">
      <link rel="next" href="jakartackbk-CHP-12-SECT-6.3.html" title="12.6.3.&nbsp;Discussion">
   </head>
   <body>
      <div id="frame">
         <div id="forbg">
            <div id="user-header">
               <div id="logo"><a href="http://www.discursive.com" title="$"><img src="../images/discursive-logo.png" border="0"></a></div>
               <div id="right-header">
                  <h2>Common Java Cookbook</h2>
                  <h4>Edition: 0.1-SNAPSHOT</h4>
               </div>
               <div style="clear:both;"></div>
               <div id="left-sidebar"></div>
            </div>
            <div class="navheader">
               <table width="100%" summary="Navigation header">
                  <tr>
                     <td width="40%" align="left"><a accesskey="p" href="jakartackbk-CHP-12-SECT-6.html">12.6.&nbsp;Creating an Index of XML Documents</a>&nbsp;
                     </td>
                     <td width="20%" align="center"><a accesskey="h" href="book.html">
                           												TOC
                                                                       </a></td>
                     <td width="40%" align="right">&nbsp;<a accesskey="n" href="jakartackbk-CHP-12-SECT-6.3.html">12.6.3.&nbsp;Discussion</a></td>
                  </tr>
               </table>
            </div>
            <div class="sect2" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h3 class="title"><a name="jakartackbk-CHP-12-SECT-6.2"></a>12.6.2.&nbsp;Solution
                        </h3>
                        <div class="section-icon"></div>
                     </div>
                  </div>
               </div>
               <p>Use Jakarta Lucene and Jakarta Digester and create an index of Lucene
                  <code class="literal">Document</code> objects for the lowest level of
                  granularity you wish to search. For example, if you are attempting to
                  search for speeches in a Shakespeare play that contain specific
                  terms, create a Lucene <code class="literal">Document</code> object for each
                  speech. For the purposes of this recipe, assume that you are
                  attempting to index Shakespeare plays stored in the following XML
                  format:
               </p><a name="I_12_tt499"></a><pre class="programlisting">
&lt;?xml version="1.0"?&gt;


&lt;PLAY&gt;
  &lt;TITLE&gt;All's Well That Ends Well&lt;/TITLE&gt;

  &lt;ACT&gt;
    &lt;TITLE&gt;ACT I&lt;/TITLE&gt;

    &lt;SCENE&gt;
      &lt;TITLE&gt;SCENE I.  Rousillon. The COUNT's palace.&lt;/TITLE&gt;

      &lt;SPEECH&gt;
        &lt;SPEAKER&gt;COUNTESS&lt;/SPEAKER&gt;
        &lt;LINE&gt;In delivering my son from me, I bury a second husband.&lt;/LINE&gt;
      &lt;/SPEECH&gt;

      &lt;SPEECH&gt;
        &lt;SPEAKER&gt;BERTRAM&lt;/SPEAKER&gt;
        &lt;LINE&gt;And I in going, madam, weep o'er my father's death&lt;/LINE&gt;
        &lt;LINE&gt;anew: but I must attend his majesty's command, to&lt;/LINE&gt;
        &lt;LINE&gt;whom I am now in ward, evermore in subjection.&lt;/LINE&gt;
      &lt;/SPEECH&gt;
    &lt;/SCENE&gt;
  &lt;/ACT&gt;
&lt;/PLAY&gt;</pre><p>The following class creates a Lucene index of Shakespeare speeches,
                  reading XML files for each play in the
                  <code class="filename">./data/Shakespeare</code> directory, and calling the
                  <code class="literal">PlayIndexer</code> to create Lucene
                  <code class="literal">Document</code> objects for every speech. These
                  <code class="literal">Document</code>
                                 <a class="indexterm" name="jakartackbk-CHP-12-ITERM-3419"></a>
                                 <a class="indexterm" name="jakartackbk-CHP-12-ITERM-3420"></a>
                  objects are then written to a Lucene index using an
                  <code class="literal">IndexWriter</code>:
               </p><a name="I_12_tt500"></a><pre class="programlisting">import java.io.File;
import java.io.FilenameFilter;

import org.apache.log4j.Logger;
import org.apache.lucene.analysis.standard.StandardAnalyzer;
import org.apache.lucene.index.IndexWriter;
import org.apache.oro.io.GlobFilenameFilter;

File dataDir = new File("./data/shakespeare");
logger.info( "Looking for XML files in " 

FilenameFilter xmlFilter = new GlobFilenameFilter( "*.xml" );
File[] xmlFiles = dataDir.listFiles( xmlFilter );

logger.info( "Creating Index");
IndexWriter writer = new IndexWriter("index", 
                                     new SimpleAnalyzer( ), true);
PlayIndexer playIndexer = new PlayIndexer( writer );
playIndexer.init( );

for (int i = 0; i &lt; xmlFiles.length; i++) {
    playIndexer.index(xmlFiles[i]);
}

writer.optimize( );
writer.close( );

logger.info( "Parsing Complete, Index Created");</pre><p>The <code class="literal">PlayIndexer</code> class, shown in <a href="jakartackbk-CHP-12-SECT-6.2.html#jakartackbk-CHP-12-EX-1" title="Example&nbsp;12-1.&nbsp;PlayIndexer using Commons Digester and Jakarta Lucene">Example 12-1</a>, parses each XML file and creates
                  <code class="literal">Document</code> objects that are written to an
                  <code class="literal">IndexWriter</code>. The
                  <code class="literal">PlayIndexer</code>
                                 <a class="indexterm" name="jakartackbk-CHP-12-ITERM-3421"></a>
                  uses Commons Digester to create a Lucene <code class="literal">Document</code>
                  object for every speech. The <code class="literal">init( )</code> method
                  creates a <code class="literal">Digester</code> instance designed to interact
                  with an inner class, <code class="literal">DigestContext</code>, which keeps
                  track of the current context of a
                  speech&#8212;<code class="literal">play</code>, <code class="literal">act</code>,
                  <code class="literal">scene</code>, <code class="literal">speaker</code>&#8212;and the
                  textual contents of a <code class="literal">speech</code>. At the end of every
                  speech element, the <code class="literal">DigestContext</code> invokes the
                  <code class="literal">processSpeech( )</code>
                                 <a class="indexterm" name="jakartackbk-CHP-12-ITERM-3422"></a>
                                 <a class="indexterm" name="jakartackbk-CHP-12-ITERM-3423"></a> method that creates a Lucene
                  <code class="literal">Document</code> for each speech and writes this
                  <code class="literal">Document</code> to the
                  Lucene<a class="indexterm" name="jakartackbk-CHP-12-ITERM-3424"></a>
                                 <code class="literal">IndexWriter</code>. Because each
                  <code class="literal">Document</code> is associated with the specific context
                  of a speech, it will be possible to obtain a specific location for
                  each term or phrase.
               </p>
               <div class="example"><a name="jakartackbk-CHP-12-EX-1"></a><p class="title"><b>Example&nbsp;12-1.&nbsp;PlayIndexer using Commons Digester and Jakarta Lucene</b></p>
                  <div class="example-contents"><pre class="programlisting">package com.discursive.jccook.xml.bardsearch;

import java.io.File;
import java.io.IOException;
import java.net.URL;

import org.apache.commons.digester.Digester;
import org.apache.commons.digester.xmlrules.DigesterLoader;
import org.apache.log4j.Logger;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.index.IndexWriter;
import org.xml.sax.SAXException;

import com.discursive.jccook.util.LogInit;

public class PlayIndexer {

    private static Logger logger = 
        Logger.getLogger( PlayIndexer.class );
    static { LogInit.init( ); }

    private IndexWriter indexWriter;
    private Digester digester;
    private DigestContext context;

    public PlayIndexer(IndexWriter pIndexWriter) {
        indexWriter = pIndexWriter;
    }
    
    public void init( ) {
        URL playRules = 
            PlayIndexer.class.getResource("play-digester-rules.xml");
        digester = DigesterLoader.createDigester( playRules );
    }
        
    public void index(File playXml) throws IOException, SAXException {
        context = new DigestContext( );
        digester.push( context );
        digester.parse( playXml );
        logger.info( "Parsed: " + playXml.getAbsolutePath( ) );
    }
    
    public void processSpeech( ) {
        Document doc = new Document( );
        doc.add(Field.Text("play", context.playTitle));
        doc.add(Field.Text("act", context.actTitle));
        doc.add(Field.Text("scene", context.sceneTitle));
        doc.add(Field.Text("speaker", context.speaker));
        doc.add(Field.Text("speech", 
                           new StringReader( context.speech.toString( ) )));
        try {
            indexWriter.addDocument( doc );
        } catch( IOException ioe ) {
            logger.error( "Unable to add document to index", ioe);
        }
    }
    
    public class DigestContext {
        File playXmlFile;
        String playTitle, actTitle, sceneTitle, speaker;
        StringBuffer speech = new StringBuffer( );

        public void setActTitle(String string) { actTitle = string; }
        public void setPlayTitle(String string) { playTitle = string; }
        public void setSceneTitle(String string){ sceneTitle = string;}
        public void setSpeaker(String string) { speaker = string; }
        public void appendLine(String pLine) { speech.append( pLine ); }

        public void speechEnd( ) {
            processSpeech( );
            speech.delete( 0, speech.length( ) );
            speaker = "";
        }
    }
}</pre></div>
               </div><br class="example-break"><p>
                                 <a href="jakartackbk-CHP-12-SECT-6.2.html#jakartackbk-CHP-12-EX-1" title="Example&nbsp;12-1.&nbsp;PlayIndexer using Commons Digester and Jakarta Lucene">Example 12-1</a> used a Digester rule set defined in
                  <a href="jakartackbk-CHP-12-SECT-6.2.html#jakartackbk-CHP-12-EX-2" title="Example&nbsp;12-2.&nbsp;Digester rules for PlayIndexer">Example 12-2</a>. This set of rules is designed to invoke
                  a series of methods in a set sequence to populate the context
                  variables for each speech. The Digester rules in <a href="jakartackbk-CHP-12-SECT-6.2.html#jakartackbk-CHP-12-EX-2" title="Example&nbsp;12-2.&nbsp;Digester rules for PlayIndexer">Example 12-2</a> never push or pop objects onto the digester
                  stack; instead, the Digester is being used to populate variables and
                  invoke methods on an object that creates Lucene
                  <code class="literal">Document</code> objects based on a set of context
                  variables. This example uses the Digester as a shorthand Simple API
                  for XML (SAX) parser; the <code class="literal">PlayIndexer</code> contains a
                  series of callback methods, and the Digester rule set simplifies the
                  interaction between the underlying SAX parser and the
                  <code class="literal">DigestContext</code>.
               </p>
               <div class="example"><a name="jakartackbk-CHP-12-EX-2"></a><p class="title"><b>Example&nbsp;12-2.&nbsp;Digester rules for PlayIndexer</b></p>
                  <div class="example-contents"><pre class="programlisting">&lt;?xml version="1.0"?&gt;

&lt;digester-rules&gt;
    &lt;pattern value="PLAY"&gt;
        &lt;bean-property-setter-rule pattern="TITLE"
                                   propertyname="playTitle"/&gt;
        &lt;pattern value="ACT"&gt;
            &lt;bean-property-setter-rule pattern="TITLE"
                                       propertyname="actTitle"/&gt;
               &lt;pattern value="PROLOGUE"&gt;
                &lt;bean-property-setter-rule pattern="TITLE"
                                           propertyname="sceneTitle"/&gt;
                &lt;pattern value="SPEECH"&gt;
                    &lt;bean-property-setter-rule pattern="SPEAKER"
                                               propertyname="speaker"/&gt;
                    &lt;call-method-rule pattern="LINE" 
                                      methodname="appendLine"
                                      paramtype="java.lang.String"
                                      paramcount="0"/&gt;
                    &lt;call-method-rule methodname="speechEnd"
                                      paramtype="java.lang.Object"/&gt;
                &lt;/pattern&gt;
            &lt;/pattern&gt;
            &lt;pattern value="SCENE"&gt;
                &lt;bean-property-setter-rule pattern="TITLE"
                                           propertyname="sceneTitle"/&gt;
                &lt;pattern value="SPEECH"&gt;
                    &lt;bean-property-setter-rule pattern="SPEAKER"
                                               propertyname="speaker"/&gt;
                    &lt;call-method-rule pattern="LINE"
                                      methodname="appendLine"
                                      paramtype="java.lang.String"
                                      paramcount="0"/&gt;
                    &lt;call-method-rule methodname="speechEnd"
                                      paramtype="java.lang.Object"/&gt;
                &lt;/pattern&gt;
               &lt;/pattern&gt;
        &lt;/pattern&gt;
    &lt;/pattern&gt;
&lt;/digester-rules&gt;</pre></div>
               </div><br class="example-break"></div>
            <div class="navfooter">
               <hr>
               <table width="100%" summary="Navigation footer">
                  <tr>
                     <td width="40%" align="left"><a accesskey="p" href="jakartackbk-CHP-12-SECT-6.html">Prev</a>&nbsp;
                     </td>
                     <td width="20%" align="center"><a accesskey="h" href="book.html">Home</a></td>
                     <td width="40%" align="right">&nbsp;<a accesskey="n" href="jakartackbk-CHP-12-SECT-6.3.html">Next</a></td>
                  </tr>
                  <tr>
                     <td width="40%" align="left" valign="top">12.6.&nbsp;Creating an Index of XML Documents&nbsp;</td>
                     <td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.sonatype.com/" title="Discursive: Discursive">Sponsored by Discursive
                                                                      </a></span></td>
                     <td width="40%" align="right" valign="top">&nbsp;12.6.3.&nbsp;Discussion</td>
                  </tr>
               </table>
            </div><br><center>
                             Copyright 2009. Discursive. All Rights Reserved.
                           
            </center><script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script type="text/javascript">
var pageTracker = _gat._getTracker("UA-1693297-1");
pageTracker._initData();
pageTracker._setDomainName(".sonatype.com");
pageTracker._trackPageview();
</script><script src="http://loopfuse.net/webrecorder/js/listen.js" type="text/javascript"></script><script type="text/javascript">
  _lf_cid = "LF_5208d25a";
_lf_remora();
</script></div>
      </div>
   </body>
</html>